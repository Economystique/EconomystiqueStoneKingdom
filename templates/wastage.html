{% extends "base.html" %}

{% block title %}Wastage - Economystique{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wastage.css') }}">
{% endblock %}

{% block content %}
<h1>Wastage</h1>
<div class="content-header">
    <p class="subtitle">Check out your wastage report</p>
    <br>
</div>

<div class="wastage-container">
    <div class="wastage-toolbar">
        <div class="wastage-search-section">
            <div class="wastage-search-container">
                <input type="text" id="wastageSearchInput" placeholder="Search" class="wastage-search-input">
            </div>
        </div>
        <div class="wastage-action-buttons">
            <button id="openModalBtn" class="btn btn-wastage">
                <span class="icon"><img class="icon-img" src="static/img/declareWastageIcon.png" alt=""></span>
                Declare Wastage
            </button>
        </div>
    </div>

    <div class="table-container">
        <table class="wastage-table">
            <thead>
                <tr>
                    <th>Inventory ID</th>
                    <th>Inventory Description</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Wastage Date</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
                {% for wastage in wastage_data %}
                <tr>
                    <td>{{ wastage.inv_id }}</td>
                    <td>{{ wastage.inv_desc }}</td>
                    <td>{{ wastage.quantity }}</td>
                    <td>{{ wastage.unit }}</td>
                    <td>{{ wastage.dec_date }}</td>
                    <td>{{ wastage.remark }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-container">
            <ul class="pagination">
                <li class="page-item" id="prevPageBtn"><span>&laquo;</span></li>
                <li class="page-item" id="nextPageBtn"><span>&raquo;</span></li>
            </ul>
        </div>
    </div>
</div>

<!-- MODAL -->
<div id="wastageModal" class="modal hidden">
    <div class="modal-content">
        <span id="closeModalBtn" class="close">&times;</span>
        <h2 class="modal-title">Declare Wastage</h2>  
        <hr>
        <br>

        <div class="modal-wrapper">
            <form id="declareWastageForm" action="{{ url_for('declare_wastage') }}" method="post">
                <div class="form-group">
                    <label for="inv_id">Inventory ID/Name</label>
                    <select name="inv_id" id="inv_id" required>
                        {% for inv in inv_data %}
                        <option value="{{ inv.id }}">{{ inv.description }} ({{ inv.unit }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="quantity">Quantity</label>
                    <input type="number" name="quantity" id="quantity" min="0.01" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="dec_date">Wastage Date</label>
                    <input type="date" name="dec_date" id="dec_date" value="{{ current_date }}" required>
                </div>

                <div class="form-group">
                    <label for="remark">Remarks</label>
                    <textarea name="remark" id="remark" rows="3" placeholder="Enter remarks..."></textarea>
                </div>
            </form>

            <div class="declare-wastage-table">
                <div class="table-wrapper">
                    <table class="waste-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Quantity</th>
                                <th>Date</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>INV001</td>
                                <td>Will to live</td>
                                <td>2025-08-15</td>
                                <td>it's time to kys</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="declare-buttons">
            <button type="button" class="btn-secondary">Cancel</button>
            <button type="submit" form="declareWastageForm" class="btn-primary">Confirm</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Pagination + Search
    const searchInput = document.getElementById('wastageSearchInput');
    const tableRows = Array.from(document.querySelectorAll('.wastage-table tbody tr'));
    const paginationContainer = document.querySelector('.pagination');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');

    let currentPage = 1;
    const rowsPerPage = 13;
    let filteredRows = [...tableRows];

    function createPageItem(text, page = null, isActive = false, isEllipsis = false) {
        const li = document.createElement('li');
        li.classList.add('page-item');
        if (isEllipsis) {
            li.classList.add('ellipsis');
            li.textContent = '...';
        } else {
            li.classList.add('numbered');
            li.textContent = text;
            li.dataset.page = page;
            if (isActive) li.classList.add('active');
            li.addEventListener('click', () => {
                currentPage = page;
                showPage(currentPage);
            });
        }
        return li;
    }

    function setupPagination() {
        document.querySelectorAll('.page-item.numbered, .page-item.ellipsis').forEach(el => el.remove());

        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (totalPages <= 1) return;

        const buffer = 2;
        const start = Math.max(2, currentPage - buffer);
        const end = Math.min(totalPages - 1, currentPage + buffer);

        paginationContainer.insertBefore(createPageItem(1, 1, currentPage === 1), nextBtn);

        if (start > 2) {
            paginationContainer.insertBefore(createPageItem('...', null, false, true), nextBtn);
        }

        for (let i = start; i <= end; i++) {
            paginationContainer.insertBefore(createPageItem(i, i, currentPage === i), nextBtn);
        }

        if (end < totalPages - 1) {
            paginationContainer.insertBefore(createPageItem('...', null, false, true), nextBtn);
        }

        paginationContainer.insertBefore(createPageItem(totalPages, totalPages, currentPage === totalPages), nextBtn);
    }

    function showPage(page) {
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        tableRows.forEach(row => row.style.display = 'none');
        filteredRows.slice(start, end).forEach(row => row.style.display = '');

        currentPage = page;
        setupPagination();
    }

    prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            showPage(currentPage);
        }
    });

    nextBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            showPage(currentPage);
        }
    });

    searchInput.addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase();
        filteredRows = tableRows.filter(row =>
            row.textContent.toLowerCase().includes(searchTerm)
        );
        currentPage = 1;
        showPage(currentPage);
    });

    showPage(currentPage);

    // Modal logic
    const modal = document.getElementById('wastageModal');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const declareForm = document.getElementById('declareWastageForm');

    function openModal() { modal.classList.remove('hidden'); }
    function closeModal() { modal.classList.add('hidden'); }

    openModalBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);

    window.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    modal.addEventListener('transitionend', () => {
        if (modal.classList.contains('hidden')) declareForm.reset();
    });
});
</script>
{% endblock %}
