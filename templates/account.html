{% extends "base.html" %}

{% block title %}Account Profile - Economystique{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/account.css') }}">
{% endblock %}

{% block content %}
<div class="whole-container">

    <!-- PERSONAL CARD -->
    <form id="personalForm" class="card personal-container" onsubmit="updateProfile(event)">
        <button id="editBtn" class="edit-btn" type="button" onclick="toggleEdit()">Edit</button>
        <button id="saveBtn" class="save-btn" type="submit" style="display: none;">Save</button>

        <div class="avatar-circle">
            <img id="avatarImg" class="avatar-img" src="{{ url_for('avatar_image', username=user_data.user_name) }}" alt="Avatar">
            <button id="avatarUploadBtn" class="avatar-upload-btn" type="button" title="Change Avatar" style="display: none;">+</button>
            <input type="file" id="avatarInput" class="file-upload-input" accept="image/*">
        </div>

        <div class="personal-text">
            <p class="section-label">{{ 'Edit profile to select title' if not user_data.owner_name else 'Business Owner' }}</p>
            <h2 class="owner-name" id="ownerNameText">{{ user_data.owner_name or user_data.user_name }}</h2>
            <input type="text" name="owner_name" id="ownerNameInput" value="{{ user_data.owner_name or user_data.user_name }}" class="editable-input" style="display: none;">

            <p class="info-line">
                <span class="info-label">Contact Information:</span>
                <span id="contactText">{{ user_data.contact or 'Edit business information' }}</span>
                <input type="text" name="contact" id="contactInput" value="{{ user_data.contact or '' }}" class="editable-input" style="display: none;">
            </p>
        </div>
    </form>

    <!-- BUSINESS CARD -->
    <form id="businessForm" class="card business-container" onsubmit="updateBusiness(event)">
        <button id="editBusinessBtn" class="edit-btn" type="button" onclick="toggleBusinessEdit()">Edit</button>
        <button id="saveBusinessBtn" class="save-btn" type="submit" style="display: none;">Save</button>
        
        <div class="biz-logo">
            <img id="bizLogoImg" class="biz-logo-img" src="{{ url_for('biz_logo_image', username=user_data.user_name) }}" alt="Business Logo">
            <button id="bizLogoUploadBtn" class="bizlogo-upload-btn" type="button" title="Change Logo" style="display: none;">+</button>
            <input type="file" id="bizLogoInput" class="file-upload-input" accept="image/*">
        </div>

        <div class="biz-text">
            <p class="section-label">Business Information</p>
            <h2 class="biz-name" id="bizNameText">{{ user_data.biz_name or 'Edit business information' }}</h2>
            <input type="text" name="biz_name" id="bizNameInput" value="{{ user_data.biz_name or '' }}" class="editable-input" style="display: none;">

            <p class="info-line">
                <span class="info-label">Industry:</span>
                <span id="industryText">{{ user_data.industry or 'Edit business information' }}</span>
                <input type="text" name="industry" id="industryInput" value="{{ user_data.industry or '' }}" class="editable-input" style="display: none;">
            </p>

            <p class="info-line">
                <span class="info-label">Business Type:</span>
                <span id="bizTypeText">{{ user_data.biz_type or 'Edit business information' }}</span>
                <input type="text" name="biz_type" id="bizTypeInput" value="{{ user_data.biz_type or '' }}" class="editable-input" style="display: none;">
            </p>

            <p class="info-line">
                <span class="info-label">Address:</span>
                <span id="addressText">{{ user_data.address or 'Edit business information' }}</span>
                <input type="text" name="address" id="addressInput" value="{{ user_data.address or '' }}" class="editable-input" style="display: none;">
            </p>
        </div>
    </form>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Hide both plus buttons on page load
window.addEventListener('DOMContentLoaded', function() {
    document.getElementById('avatarUploadBtn').style.display = 'none';
    document.getElementById('bizLogoUploadBtn').style.display = 'none';
});

function toggleEdit() {
    const showText = (id, show) => {
        document.getElementById(id + 'Text').style.display = show ? 'inline' : 'none';
        document.getElementById(id + 'Input').style.display = show ? 'none' : 'inline-block';
    };
    ['ownerName', 'contact'].forEach(id => showText(id, false));
    document.getElementById('editBtn').style.display = 'none';
    document.getElementById('saveBtn').style.display = 'inline-block';
    // Show only avatar upload button in user profile edit mode
    document.getElementById('avatarUploadBtn').style.display = 'flex';
    document.getElementById('bizLogoUploadBtn').style.display = 'none';
}
function toggleBusinessEdit() {
    const showText = (id, show) => {
        document.getElementById(id + 'Text').style.display = show ? 'inline' : 'none';
        document.getElementById(id + 'Input').style.display = show ? 'none' : 'inline-block';
    };
    ['bizName', 'industry', 'bizType', 'address'].forEach(id => showText(id, false));
    document.getElementById('editBusinessBtn').style.display = 'none';
    document.getElementById('saveBusinessBtn').style.display = 'inline-block';
    // Show only biz logo upload button in business info edit mode
    document.getElementById('bizLogoUploadBtn').style.display = 'flex';
    document.getElementById('avatarUploadBtn').style.display = 'none';
}
function updateProfile(event) {
    event.preventDefault();
    const formData = {
        owner_name: document.getElementById('ownerNameInput').value,
        contact: document.getElementById('contactInput').value
    };
    fetch('/api/update_personal_profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('ownerNameText').textContent = formData.owner_name;
            document.getElementById('contactText').textContent = formData.contact;
            const showText = (id, show) => {
                document.getElementById(id + 'Text').style.display = show ? 'inline' : 'none';
                document.getElementById(id + 'Input').style.display = show ? 'none' : 'inline-block';
            };
            ['ownerName', 'contact'].forEach(id => showText(id, true));
            document.getElementById('editBtn').style.display = 'inline-block';
            document.getElementById('saveBtn').style.display = 'none';
            // Hide avatar upload button after saving
            document.getElementById('avatarUploadBtn').style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating profile');
    });
}
function updateBusiness(event) {
    event.preventDefault();
    const formData = {
        biz_name: document.getElementById('bizNameInput').value,
        industry: document.getElementById('industryInput').value,
        biz_type: document.getElementById('bizTypeInput').value,
        address: document.getElementById('addressInput').value
    };
    fetch('/api/update_business_profile', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('bizNameText').textContent = formData.biz_name;
            document.getElementById('industryText').textContent = formData.industry;
            document.getElementById('bizTypeText').textContent = formData.biz_type;
            document.getElementById('addressText').textContent = formData.address;
            const showText = (id, show) => {
                document.getElementById(id + 'Text').style.display = show ? 'inline' : 'none';
                document.getElementById(id + 'Input').style.display = show ? 'none' : 'inline-block';
            };
            ['bizName', 'industry', 'bizType', 'address'].forEach(id => showText(id, true));
            document.getElementById('editBusinessBtn').style.display = 'inline-block';
            document.getElementById('saveBusinessBtn').style.display = 'none';
            // Hide biz logo upload button after saving
            document.getElementById('bizLogoUploadBtn').style.display = 'none';
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating business information');
    });
}
// Avatar upload
const avatarInput = document.getElementById('avatarInput');
const avatarUploadBtn = document.getElementById('avatarUploadBtn');
avatarUploadBtn.style.display = 'none';
avatarUploadBtn.addEventListener('click', function() {
    avatarInput.click();
});
avatarInput.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('avatar', file);
    fetch('/api/upload_avatar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('avatarImg').src = data.avatar_url + '?t=' + new Date().getTime();
        } else {
            alert('Avatar upload failed: ' + data.error);
        }
    })
    .catch(() => alert('Avatar upload failed.'));
});
// Biz logo upload
const bizLogoInput = document.getElementById('bizLogoInput');
const bizLogoUploadBtn = document.getElementById('bizLogoUploadBtn');
bizLogoUploadBtn.style.display = 'none';
bizLogoUploadBtn.addEventListener('click', function() {
    bizLogoInput.click();
});
bizLogoInput.addEventListener('change', function() {
    const file = this.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('biz_logo', file);
    fetch('/api/upload_biz_logo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('bizLogoImg').src = data.logo_url + '?t=' + new Date().getTime();
        } else {
            alert('Logo upload failed: ' + data.error);
        }
    })
    .catch(() => alert('Logo upload failed.'));
});
</script>
{% endblock %}
